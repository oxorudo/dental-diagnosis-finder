{% load static %}
{% load custom_filters %}
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}치과 상병 코드 검색{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
</head>

<body>
  <div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-2 sidebar py-4">
            <ul class="nav flex-column">
                <li class="nav-item mb-3">
                    <a class="nav-link active" href="#">치과 상병 코드 검색</a>
                </li>
                <li class="nav-item mb-3">
                    <a class="nav-link" href="#">통계</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">추가</a>
                </li>
            </ul>
        </nav>

        <!-- Main content -->
        <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4 py-4">
            <!-- Search bar -->
            <div class="d-flex justify-content-between align-items-center search-area">
                <form method="GET" action="{% url 'search_view' %}" class="d-flex w-100">
                    <input type="text" class="form-control me-2" name="q" id="search-input" placeholder="상병 코드 또는 상병명을 입력하세요" value="{{ query }}">
                    <button class="btn btn-primary search-btn" type="submit">검색</button>
                </form>
            </div>

            <!-- Table and details section -->
            <div class="row mt-4">
                <!-- Result table -->
                <div class="col-md-12 result-table">
                    <div class="table-responsive table-body-wrapper">
                        <table class="table table-fixed-header">
                            <thead>
                                <tr>
                                    <th class="col-code">불완전 상병 코드</th>
                                    <th class="col-name">불완전 상병명</th>
                                    <th class="col-category">카테고리</th>
                                    <th class="col-details">세부 청구 항목</th>
                                </tr>
                            </thead>
                            <tbody id="result-body">
                                {% if results %}
                                    {% for row in results %}
                                        <tr data-code="{{ row.0 }}" data-name="{{ row.1 }}" data-category="{{ row.2|default:'없음' }}" data-details="{{ row.3|default:'없음' }}">
                                            <td class="col-code">{{ row.0 }}</td>
                                            <td class="col-name">{{ row.1 }}</td>
                                            <td class="col-category">{{ row.2|default:'없음' }}</td>
                                            <td class="col-details">{{ row.3|default:'없음' }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center">검색 결과가 없습니다.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Detail section -->
                <div class="col-md-12 detail-area mt-3">
                    <div class="card detail-card">
                        <div class="card-body">
                            <h5 class="card-title">상세 정보</h5>
                            <div id="detail-content">
                                <!-- Selected row details -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('#result-body tr');

            rows.forEach(row => {
                row.addEventListener('click', function () {
                    rows.forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');

                    const code = this.getAttribute('data-code');
                    const name = this.getAttribute('data-name');
                    const category = this.getAttribute('data-category');
                    const details = this.getAttribute('data-details');

                    const detailContent = document.getElementById('detail-content');
                    
                    // Split 'details' into buttons
                    const detailsArray = details.split(' | ');
                    let buttonsHTML = '';
                    detailsArray.forEach(detail => {
                        buttonsHTML += `<button class="btn btn-outline-secondary btn-sm detail-btn" type="button" data-detail="${detail}">${detail}</button> `;
                    });

                    // Update detail content
                    detailContent.innerHTML = `
                        <p><strong>불완전 상병 코드:</strong> ${code}</p>
                        <p><strong>불완전 상병명:</strong> ${name}</p>
                        <p><strong>청구 카테고리:</strong> ${category}</p>
                        <p><strong>세부 청구 항목:</strong></p>
                        ${buttonsHTML}
                    `;

                    // Add click events to buttons (AJAX request)
                    const detailButtons = document.querySelectorAll('.detail-btn');
                    detailButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            const detail = this.getAttribute('data-detail');

                            // AJAX request
                            fetch('/detail-action/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify({
                                    detail: detail,
                                    code: code
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.link) {
                                    window.open(data.link, '_blank');
                                } else {
                                    alert('링크를 찾을 수 없습니다.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                        });
                    });
                });
            });
        });

        // CSRF token retrieval function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>

</html>
